PykCharts={},PykCharts.BubblePack=function(a){this.execute=function(){var b=this;d3.json(a.data,function(a,c){b.data=c,b.render(),b.renderTooltip()})},this.render=function(){function b(a){function b(a,d){d.children?d.children.forEach(function(a){b(d.name,a)}):(console.log("className:"+d),console.log("ttip:"+d.ttip),console.log("color:"+d.colors),c.push({packageName:a,className:d.name,value:d.size,tip:d.ttip,color:d.colors}))}var c=[];return b(null,a),console.log("classes:"+c.ttip),{children:c}}{var c=this,d=600,e=d3.format(",d"),f=d3.scale.category20c(),g=d3.layout.pack().sort(null).size([d,d]).padding(1.5),h=d3.select(a.selection).append("svg").attr("width",d).attr("height",d).attr("class","bubble");d3.scale.linear().domain([0,1e4]).range([0,d])}d3.json(a.data,function(a,d){var i=h.selectAll(".node").data(g.nodes(b(d)).filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});i.append("title").text(function(a){return a.className+": "+e(a.value)}),i.append("circle").attr("r",function(a){return a.r}).on("mouseover",function(a){return c.tooltip.html(a.tip).style("visibility","visible")}).on("mousemove",function(){return c.tooltip.style("top",event.pageY-10+"px").style("left",event.pageX+10+"px")}).on("mouseout",function(){return c.tooltip.style("visibility","hidden")}).style("fill",function(a){return f(a.packageName)}),i.append("text").attr("dy",".3em").style("text-anchor","middle").text(function(a){return a.className.substring(0,a.r/3)})}),d3.select(self.frameElement).style("height",d+"px")},this.renderTooltip=function(){$("#pyk-bubble-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-bubble-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")}},PykCharts.Chord=function(a){return this.execute=function(){if(!this.validate_options())return!1;var a=this;d3.json(a.options.relations,function(b,c){a.relations=c,d3.json(a.options.frequency,function(b,c){a.frequency=c,a.render()})})},this.validate_options=function(){return void 0==this.options.selection?!1:void 0==this.options.relations?!1:void 0==this.options.frequency?!1:!0},this.options=jQuery.extend({width:850,height:700},a),this.render=function(){this.nicks=this.frequency.map(function(a){return a.nick}),this.rawdata_to_chartdata(),this.renderChord()},this.renderChord=function(){function a(a){return function(b,c){0==a?($(".spinning").css("-webkit-animation-play-state","paused"),$(".spinning").css("animation-play-state","paused")):($(".spinning").css("-webkit-animation-play-state","running"),$(".spinning").css("animation-play-state","runnin")),e.selectAll("g.chord path").filter(function(a){return a.source.index!=c&&a.target.index!=c}).transition().style("opacity",a)}}var b=this,c=this.options.height,d=this.options.width,e=d3.select(this.options.selection).append("svg").attr("class","pyk-chord spinning").attr("width",d).attr("height",c).append("g").attr("transform","translate("+d/2+","+c/2+")"),f=d3.scale.ordinal().range([b.options.color]),g=.31*Math.min(d,c),h=1.1*g,i=d3.layout.chord().padding(.05).sortSubgroups(d3.descending).matrix(b.matrix);e.append("g").attr("class","circumference").selectAll("path").data(i.groups).enter().append("path").style("fill",function(a){return f(a.index)}).style("stroke",function(a){return f(a.index)}).attr("d",d3.svg.arc().innerRadius(g).outerRadius(h)).on("mouseover",a(0)).on("mouseout",a(1)),e.append("g").attr("class","chord").selectAll("path").data(i.chords).enter().append("path").style("fill",function(a){return f(a.target.index)}).attr("d",d3.svg.chord().radius(g)).style("opacity",1);var j=e.append("svg:g").selectAll("g").data(i.groups).enter().append("svg:g").attr("transform",function(a){return"rotate("+(180*a.startAngle/Math.PI-90)+")translate("+h+",0)"});j.append("svg:text").attr("x",8).attr("dy",".35em").attr("text-anchor",function(a){return a.angle>Math.PI?"end":null}).attr("transform",function(a){return a.angle>Math.PI?"rotate(180)translate(-16)":null}).text(function(a){return b.nicks[a.index]})},this.rawdata_to_chartdata=function(){function a(){for(var a=0;a<b.nicks.length;a++){c[a]=[];for(var d=0;d<b.nicks.length;d++)c[a][d]=0}}var b=this,c=[];a();for(i in this.relations){var d=this.relations[i];c[b.nicks.indexOf(d.from)][b.nicks.indexOf(d.to)]=d.messages}this.matrix=c},this},PykCharts.Choropleth=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='/pykcharts/images/spinner.gif'> Loading... Please wait");var a=this,b=this.options;d3.json(b.topojson,function(c,d){d3.json(b.state_data,function(c,e){d3.json(b.county_data,function(b,c){a.render(d,e,c)})})})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.topojson?!1:void 0===this.options.county_data?!1:void 0===this.options.state_data?!1:!0},this.options=jQuery.extend({width:960,height:500,scale:4},a),this.render=function(a,b,c){$(this.options.selection).html("");var d=this.options.height,e=this.options.width;this.legends_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-legend-holder").attr("height",30).attr("width",e),this.map_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-map-holder").attr("height",d-30).attr("width",e);var f=Object.keys(b["0"]);this.param=f[0],this.renderTooltip(),this.draw(a,b,c)},this.renderTooltip=function(){$("#choropleth-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","choropleth-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.draw=function(a,b,c){this.renderLegends(a,b,c),this.renderMaps(a,b,c)},this.renderLegends=function(a,b,c){var d=this,e=Object.keys(b["0"]),f=this.options.width/e.length,g=this.legends_group.selectAll("text").data(e);g.enter().append("text"),g.attr("y",15).attr("x",function(a,b){return b*f+25}).text(function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}).on("click",function(e){d.param=e,d.draw(a,b,c)});var h=this.legends_group.selectAll("circle").data(e);h.enter().append("circle"),h.attr("cy",10).attr("cx",function(a,b){return b*f+15}).attr("r",7).attr("style",function(a){var b=a===d.param?"#000":"#fff";return"stroke-width: 3px; stroke: #000; fill: "+b}).on("click",function(e){d.param=e,d.draw(a,b,c)})},this.renderMaps=function(a,b,c){var d=this,e=d3.geo.path(),f=this.options.scale,g=this.options.height,h=this.options.width,i=this.param,j=this.map_group;this.map_group.selectAll("g").remove();var l=j.append("g").attr("class","counties"),m=j.append("g").attr("class","states");l.selectAll("path").data(topojson.feature(a,a.objects.counties).features).enter().append("path").attr("class","county").attr("d",e).attr("style",function(a){if(c[a.id]){var b=c[a.id][i].color,d=1;return c[a.id][i].data&&(d=c[a.id][i].data/100),"fill: "+b+"; opacity: "+d}}).on("click",function(){var a,b,c;a=h/2,b=g/2,c=1,m.transition().ease("back").duration(1200).attr("transform","translate("+h/2+","+g/2+")scale("+c+")translate("+-a+","+-b+")"),l.transition().ease("back").duration(1200).attr("transform","translate("+h/2+","+g/2+")scale("+c+")translate("+-a+","+-b+")"),$("g.counties").fadeOut(),$("g.states path").css("fill",function(){return $(this).attr("data-color")}),$("g.states path").css("opacity",function(){return $(this).attr("data-heat")})}).on("mouseover",function(a){if(c[a.id]){var b=c[a.id][i].tooltip;d.tooltip.html(b),d.tooltip.style("visibility","visible")}}).on("mousemove",function(){var a=parseInt(d.tooltip.style("height"))+40,b=parseInt(d.tooltip.style("width"))/2;d.tooltip.style("top",event.pageY-a+"px").style("left",event.pageX-b+"px")}).on("mouseout",function(){d.tooltip.style("visibility","hidden")}),m.selectAll("path").data(topojson.feature(a,a.objects.states).features).enter().append("path").attr("class","state").attr("d",e).attr("data-heat",function(a){return b[a.id]?b[a.id][i].data?b[a.id][i].data/100:1:1}).attr("data-color",function(a){return b[a.id]?b[a.id][i].color:"black"}).attr("style",function(a){if(!b[a.id])return console.log(a.id),void 0;var c=b[a.id][i].color,d=1;return b[a.id][i].data&&(d=b[a.id][i].data/100),"fill: "+c+"; opacity: "+d}).on("click",function(a){var b=e.centroid(a),c=b[0],d=b[1];k=f,l.transition().delay(250).ease("elastic").duration(1200).attr("transform","translate("+h/2+","+g/2+")scale("+k+")translate("+-c+","+-d+")"),m.transition().delay(250).ease("elastic").duration(1200).attr("transform","translate("+h/2+","+g/2+")scale("+k+")translate("+-c+","+-d+")"),$("g.states path").css("fill","#fff"),$(this).css("fill","none"),$("g.states path").animate({opacity:.9}),$("g.counties").show()}).on("mouseover",function(a){if(c[a.id]){var b=c[a.id][i].tooltip;d.tooltip.html(b),d.tooltip.style("visibility","visible")}}).on("mousemove",function(){var a=parseInt(d.tooltip.style("height"))+40,b=parseInt(d.tooltip.style("width"))/2;d.tooltip.style("top",event.pageY-a+"px").style("left",event.pageX-b+"px")}).on("mouseout",function(){d.tooltip.style("visibility","hidden")}),$("g.counties").hide()},this},PykCharts.GoogleHeat=function(a){return this.execute=function(){if(!this.validate_options())return!1;this.container=$(this.options.selection),this.div=$("<div>").css("height",this.options.height+"px").css("width",this.options.width+"px"),this.container.append(this.div);var a=this;$.getJSON(this.options.data,function(b){a.data=b,a.render()})},this.validate_options=function(){return void 0==this.options.selection?!1:void 0==this.options.data?!1:!0},this.options=jQuery.extend({width:960,height:500,center:new google.maps.LatLng(-25.363882,131.044922),defaultZoom:3,tooltipZoom:4},a),this.render=function(){var a=this.div.get(0),b={center:this.options.center,zoom:this.options.defaultZoom,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(a,b),this.map.setOptions({styles:this.setupStyle()}),this.setupHeat(),this.setupMarkers()},this.setupStyle=function(){return[{stylers:[{hue:"#FFBB78"},{visibility:"simplified"},{gamma:.5},{weight:.5}]},{elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"water",stylers:[{color:"#1F77B4"}]}]},this.setupHeat=function(){var a=new google.maps.MVCArray(this.heatData()),b=new google.maps.visualization.HeatmapLayer({data:a});b.setMap(this.map)},this.setupMarkers=function(){var a=this,b=new MarkerManager(a.map),c=[];for(i in this.data){var d=this.data[i],e=new google.maps.Marker({position:new google.maps.LatLng(d.latitude,d.longitude),title:d.tooltip,icon:d.marker});c.push(e);var f=new google.maps.InfoWindow({content:d.tooltip});google.maps.event.addListener(e,"click",function(b){return function(){b.open(a.map,this)}}(f))}google.maps.event.addListener(b,"loaded",function(){b.addMarkers(c,a.options.tooltipZoom),b.refresh()})},this.heatData=function(){var a=[];for(i in this.data){var b=this.data[i],c=new google.maps.LatLng(b.latitude,b.longitude);a.push({location:c,weight:b.count})}return a},this},PykCharts.River=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='/pykcharts/images/spinner.gif'> Loading... Please wait");var a=this,b=this.options;d3.json(b.data,function(b,c){a.data=c,a.render()})},this.validate_options=function(){return void 0==this.options.selection?!1:void 0==this.options.data?!1:this.options.width<300?!1:!0},this.options=jQuery.extend({width:960,height:200,filterList:[],fullList:[],extended:!1},a),this.render=function(){$(this.options.selection).html("");var a=this.options.height,b=this.options.width;this.svg=d3.select(this.options.selection).append("svg").attr("class","pyk-river").attr("height",a).attr("width",b),this.legends_group=this.svg.append("g").attr("class","legend-holder").attr("transform","translate(0,15)"),this.map_group=this.svg.append("g").attr("class","map-holder"),this.renderTooltip(),this.draw()},this.renderTooltip=function(){$("#river-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","river-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.draw=function(){this.renderLegends(),this.renderChart()},this.renderLegends=function(){var a=this,b=(this.legends_group.append("g").attr("class","option-holder").attr("transform","translate(0,15)"),[{name:"Percentage",on:this.extended},{name:"Absolute",on:!this.extended}]),c=d3.select("g.option-holder").selectAll("text").data(b);c.enter().append("text").text(function(a){return a.name}).attr("transform",function(a,b){return"translate("+(100*b+20)+",0)"}).on("click",function(){a.extended=!a.extended,a.draw()});var d=d3.select("g.option-holder").selectAll("circles").data(b);d.enter().append("circle").attr("cx",function(a,b){return 100*b+10}).attr("cy",-6).attr("r",6).attr("style",function(a){var b=a.on?"#000":"#fff";return"fill: "+b+"; stroke-width: 3px; stroke:#000"}).on("click",function(){a.extended=!a.extended,a.draw()});var e=this.data[0].breakup,f=(this.options.width-250)/e.length,g=this.legends_group.append("g").attr("class","legend-holder").attr("transform","translate(250,15)");g.selectAll("g.legend").data(e).enter().append("g").attr("class","legend").attr("transform",function(a,b){var c=b*f;return"translate("+c+",0)"}).on("click",function(b){a.toggleFilter(b.name)});var h=d3.selectAll("g.legend")[0];for(i in e){var j=d3.select(h[i]);j.selectAll("text").data([e[i]]).enter().append("text").text(function(b){return a.options.filterList.push(b.name),a.options.fullList.push(b.name),b.name}).attr("transform","translate(20,-1)");var k=j.selectAll("circle").data([e[i]]);k.enter().append("circle"),k.attr("cx",9).attr("cy",-6).attr("r",6).attr("style",function(b){var c=-1===a.options.filterList.indexOf(b.name)?"#fff":b.color;return 0===a.options.filterList.length&&(c=b.color),"fill: "+c+"; stroke-width: 3px; stroke:"+b.color})}},this.renderChart=function(){var a=jQuery.extend(!0,[],this.data),b=40,c=this;a=this.filter(a),a=this.parseData(a);var d=this.maxTotal(a),e=this.options.width,f=this.options.height,g=d3.scale.linear().domain([0,d]).range([0,e-200]),h=d3.scale.linear().domain([0,f]).range([b,f]),j=f/(2*a.length),k=2*j,l=this.map_group;l.selectAll("line.top_line").data(a).enter().append("line").attr("class","top_line").attr("x1",0).attr("x2",e).attr("y1",function(a,b){return h(b*k)}).attr("y2",function(a,b){return h(b*k)}),l.selectAll("line.bottom_line").data(a).enter().append("line").attr("class","bottom_line").attr("x1",0).attr("x2",e).attr("y1",function(a,b){return h(b*k+j)}).attr("y2",function(a,b){return h(b*k+j)});var m=l.selectAll("g.bar-holder").data(a);m.enter().append("g").attr("class","bar-holder").attr("transform",function(a,b){var c=h(b*k),e=g((d-a.breakupTotal)/2)+100;return"translate("+e+","+c+")"}),m.transition().duration(1e3).attr("height",h(j)).attr("width",function(a){return g(a.breakupTotal)}).attr("transform",function(a,b){var f=h(b*k),i=g((d-a.breakupTotal)/2)+100,j=1,l=1;if(c.extended){var m=g(a.breakupTotal);j=(e-200)/m,l=2,i=h(100)}return"translate("+i+","+f+") scale("+j+", "+l+")"}),m.exit().remove();var n=d3.selectAll("g.bar-holder")[0];for(i in a){var o=n[i],p=a[i].breakup,q=d3.select(o).selectAll("rect").data(p);q.enter().append("rect").attr("width",0),q.transition().duration(1e3).attr("x",function(a,b){if(0==b)return 0;for(var c=0,d=0;b>d;d++)c+=p[d].count;return g(c)}).attr("y",0).attr("height",function(){return j*(f-b)/f}).attr("width",function(a){return g(a.count)}),q.attr("style",function(a){return"fill: "+a.color}).on("mouseover",function(a){c.tooltip.html(a.tooltip),c.tooltip.style("visibility","visible")}).on("mousemove",function(){var a=parseInt(c.tooltip.style("height"))+40,b=parseInt(c.tooltip.style("width"))/2;c.tooltip.style("top",event.pageY-a+"px").style("left",event.pageX-b+"px")}).on("mouseout",function(){c.tooltip.style("visibility","hidden")}).on("click",function(a){c.onlyFilter(a.name)}),q.exit().transition().duration(1e3).attr("width",0).remove()}var r=l.selectAll("text.cool_label").data(a);r.enter().append("text").attr("class","cool_label"),r.attr("x",e).attr("y",function(a,b){return h(b*k+j/2+5)}).text(function(a){return a.display_name});var s=l.selectAll("text.left_label").data(a);s.enter().append("svg:text").attr("class","left_label"),s.attr("y",function(a,b){return h(b*k+j/2+5)}).attr("x",0).text(function(a){return a.breakupTotal+" "+a.technical_name});var t=l.selectAll("text.right_label").data(a);if(t.enter().append("svg:text").attr("class","right_label"),t.attr("y",function(a,b){return h(b*k+1.5*j+5)}).attr("x",e).text(function(b,c){return void 0==a[c+1]?(console.log("RiverChart: Error: Duration given for last bar"),""):b.duration}),this.extended)return $("line.left_line").fadeOut(),$("line.right_line").fadeOut(),void 0;var u=l.selectAll("line.left_line").data(a);u.enter().append("line").attr("class","left_line").attr("y2",function(a,b){return h(b*k+j)}).attr("x2",function(a){return g((d-a.breakupTotal)/2)+100}),u.transition().duration(1e3).attr("style",function(b,c){return a[c+1]?void 0:"stroke-width: 0"}).attr("y1",function(a,b){return h(b*k+j)}).attr("x1",function(a){return g((d-a.breakupTotal)/2)+100}).attr("y2",function(a,b){return h((b+1)*k)}).attr("x2",function(b,c){return a[c+1]?g((d-a[c+1].breakupTotal)/2)+100:0});var v=l.selectAll("line.right_line").data(a);v.enter().append("line").attr("class","right_line").attr("y2",function(a,b){return h(b*k+j)}).attr("x2",function(a){return g((d-a.breakupTotal)/2+a.breakupTotal)+100}),v.transition().duration(1e3).attr("style",function(b,c){return a[c+1]?void 0:"stroke-width: 0"}).attr("y1",function(a,b){return h(b*k+j)}).attr("x1",function(a){return g((d-a.breakupTotal)/2+a.breakupTotal)+100}).attr("y2",function(a,b){return h((b+1)*k)}).attr("x2",function(b,c){return a[c+1]?g((d-a[c+1].breakupTotal)/2+a[c+1].breakupTotal)+100:0})},this.filter=function(a){this.options.filterList.length<1&&(this.options.filterList=jQuery.extend(!0,[],this.options.fullList));for(i in a){var b=a[i].breakup,c=[];for(j in b)jQuery.inArray(b[j].name,this.options.filterList)>=0&&c.push(b[j]);a[i].breakup=c}return a},this.onlyFilter=function(a){var b=this.options.filterList.indexOf(a);1===this.options.filterList.length&&-1!=b?this.options.filterList=[]:(this.options.filterList=[],this.options.filterList.push(a)),this.draw()},this.toggleFilter=function(a){var b=this.options.filterList.indexOf(a);-1===b?this.options.filterList.push(a):this.options.filterList.splice(b,1),this.draw()},this.totalInBreakup=function(a){var b=0;for(i in a)b+=a[i].count;return b},this.maxTotal=function(a){var b=[];for(i in a)b.push(a[i].breakupTotal);return b=b.sort(function(a,b){return a-b}),b[b.length-1]},this.parseData=function(a){for(i in a)a[i].breakupTotal=this.totalInBreakup(a[i].breakup);return a},this},PykCharts.treerect=function(a){this.execute=function(){var b=this;width=this.options.width,height=this.options.height,d3.json(a.data,function(a,c){b.data=c,b.render(),b.renderTooltip()})},this.options=jQuery.extend({width:550,height:400},a),this.render=function(){var b,c,d=this,e=width-60,f=height-135,g=(d3.scale.linear().range([0,e]),d3.scale.linear().range([0,f]),d3.layout.treemap().round(!1).size([e,f]).sticky(!0).value(function(a){return a.size})),h=d3.select(a.selection).append("div").attr("class","chart").style("width",e+"px").style("height",f+"px").append("svg:svg").attr("width",e).attr("height",f).append("svg:g").attr("transform","translate(.5,.5)");d3.json(a.data,function(a){c=b=a;var e=g.nodes(b).filter(function(a){return!a.children}),f=h.selectAll("g").data(e).enter().append("svg:g").attr("class","cell").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});f.append("svg:rect").attr("width",function(a){return a.dx-1}).attr("height",function(a){return a.dy-1}).on("mouseover",function(a){return d.tooltip.html(a.ttip).style("visibility","visible")}).on("mousemove",function(){return d.tooltip.style("top",event.pageY-10+"px").style("left",event.pageX+10+"px")}).on("mouseout",function(){return d.tooltip.style("visibility","hidden")}).style("fill",function(a){return a.colors}),f.append("image").attr("xlink:href",function(a){return a.img}).attr("x",10).attr("y",7).attr("width",17.92).attr("height",16),f.append("svg:text").attr("x",function(a){return a.dx/2}).attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(a){return a.name}).attr("fill","white").style("opacity",function(a){return a.w=this.getComputedTextLength(),a.dx>a.w?1:0})})},this.renderTooltip=function(){$("#pyk-tree-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-tree-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")}},PykCharts.Ultimate=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='css/img/spinner.gif'> Loading... Please wait");var a=this;console.log("called"),d3.json(this.options.data,function(b,c){a.data=c,a.render()})},this.validate_options=function(){return void 0==this.options.selection?!1:void 0==this.options.data?!1:void 0==this.options.height?!1:void 0==this.options.width?!1:this.options.width<300?!1:!0},this.options=jQuery.extend({filterList:[],fullList:[],extended:!1,margins:{left:40,right:20,top:10,bottom:80}},a),this.render=function(){$(this.options.selection).html("");var a=this.options.height,b=this.options.width;this.svg=d3.select(this.options.selection).append("svg").attr("class","pyk-ultimate").attr("height",a).attr("width",b),this.svg.append("g").attr("class","yaxis"),this.svg.append("g").attr("class","xaxis"),this.chart_group=this.svg.append("g").attr("class","chart-holder").attr("width",b-(this.options.margins.right+this.options.margins.left)).attr("height",a-(this.options.margins.top+this.options.margins.bottom)).attr("transform","translate("+this.options.margins.left+","+this.options.margins.top+")"),this.legends_group=this.svg.append("g").attr("class","legend-holder").attr("transform","translate(0,15)");var c=this.rawdata_to_chartdata();this.the_bars=c[0],this.the_keys=c[1],this.the_layers=this.layers(this.the_bars),this.renderTooltip(),this.draw()},this.rawdata_to_chartdata=function(){var a=[-1],b={};for(i in this.data){var c=this.data[i];for(cat_name in c){for(j in c[cat_name]){var d="i"+i+"j"+j,e=Object.keys(c[cat_name][j])[0];b[d]=e,c[cat_name][j].id=d,c[cat_name][j].group=cat_name,a.push(c[cat_name][j])}a.push(i)}}return[a,b]},this.renderTooltip=function(){$("#pyk-ultimate-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-ultimate-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.draw=function(){this.renderLegends(),this.renderChart()},this.renderLegends=function(){},this.getGroups=function(){var a={};for(i in this.the_bars){var b=this.the_bars[i];b.id&&(a[b.group]?a[b.group].push(b.id):a[b.group]=[b.id])}return a},this.renderChart=function(){var a=this,b=this.chart_group.attr("width"),c=this.chart_group.attr("height"),d=this.the_bars,e=this.the_keys,f=this.the_layers,g=this.getGroups(),h=(d3.layout.stack().values(function(a){return a.values})(f),[]);f.map(function(a,b){for(b in a.values){var c=a.values[b];h.push(c.y+c.y0)}});var j=d3.scale.ordinal().domain(d.map(function(a,b){return a.id||b})).rangeBands([0,b],.2),k=d3.scale.linear().domain([0,d3.max(h)]).range([a.options.margins.top,c]).nice(),l=d3.scale.linear().domain([d3.max(h),0]).range([a.options.margins.top,c]).nice(),m=(d3.scale.category10(),d3.svg.axis().scale(l).tickSize(-b,0,0).orient("left")),n=d3.svg.axis().scale(j).tickSize(-c,0,0).tickFormat(function(a){return e[a]?e[a]:void 0}).orient("bottom");this.svg.select("g.yaxis").transition(1e3).attr("transform","translate("+this.options.margins.left+", "+this.options.margins.top+")").call(m);var o=parseInt(this.options.margins.top)+parseInt(c);this.svg.select("g.xaxis").transition(1e3).attr("transform","translate("+this.options.margins.left+", "+o+")").call(n).selectAll("text").style("text-anchor","start").attr("dy","2px").attr("dx","20px").attr("transform",function(){return"rotate(90)"});var p=[];for(i in g){var q=g[i],r=j(q[0]),s=j.rangeBand()*q.length,r=r+s/2;p.push({x:r,name:i})}this.svg.selectAll("text.group_label").data(p).enter().append("text").attr("class","group_label").attr("x",function(b){return b.x+a.options.margins.left}).attr("y",function(){return parseInt(c)+24}).attr("text-anchor","middle").text(function(a){return a.name});var t=this.chart_group.selectAll("g.bars").data(f).enter().append("g").attr("class","bars"),u=t.selectAll("rect").data(function(a){return a.values}).enter().append("svg:rect").attr("height",0).attr("y",c).on("mouseover",function(b){a.tooltip.html(b.tooltip),a.tooltip.style("visibility","visible")}).attr("fill",function(a){return a.color}).on("mousemove",function(){var b=parseInt(a.tooltip.style("height"))+40,c=parseInt(a.tooltip.style("width"))/2;a.tooltip.style("top",event.pageY-b+"px").style("left",event.pageX-c+"px")}).on("mouseout",function(){a.tooltip.style("visibility","hidden")});u.transition().duration(1e3).attr("x",function(a){return j(a.x)}).attr("width",function(){return j.rangeBand()}).attr("height",function(a){return k(a.y)}).attr("y",function(a){return c-k(a.y0+a.y)})},this.layers=function(a){function b(a){for(i in d){var b=d[i];if(b.name==a)return b}return c(a)}function c(a){var b={name:a,values:[]};return d.push(b),b}var d=[];for(i in a){var e=a[i];if(e.id){var f=e.id;for(k in e)if("id"!==k){var g=e[k];for(j in g){var h=g[j];if(h.name){var l=b(h.name);l.values.push({x:f,y:h.val,color:h.color,tooltip:h.tooltip})}}}}}return d},this};