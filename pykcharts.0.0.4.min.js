PykCharts={};var renderCredits=function(a,b,c,d,e){var f,g=!0;g===!0&&(d3.select("svg."+a).append("text").attr("x",10).attr("y",c-2).text("Visualization by").attr("class","pyk-credits"),f=d3.select("svg."+a).append("a").attr("xlink:href","http://pykih.com").attr("target","_blank"),f.append("text").attr("x",87).attr("y",c-2).text("pykih.com").attr("class","pyk-credits")),""===d&&""!==e?(f=d3.select("svg."+a).append("a").attr("xlink:href",e).attr("target","_blank"),f.append("text").attr("x",b-100).attr("y",c-2).text("Source").attr("class","pyk-credits")):""!==d&&""===e?d3.select("svg."+a).append("text").attr("x",b-100).attr("y",c-2).text("Source: "+d).attr("class","pyk-credits"):""!==d&&""!==e&&(d3.select("svg."+a).append("text").attr("x",b-100).attr("y",c-2).text("Source:").style("class","pyk-credits"),f=d3.select("svg."+a).append("a").attr("xlink:href",e).attr("target","_blank"),f.append("text").attr("x",b-60).attr("y",c-2).text(d).attr("class","pyk-credits"))};PykCharts.choroplethOneLayer=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='https://s3.amazonaws.com/PykCharts/spinner.gif'> Loading... Please wait");var a=this;a.h=this.options.height,a.w=this.options.width,a.cs=this.options.colorscale,a.cc=this.options.colorcode,a.color_domain=[],a.projectionScale=this.options.projectionScale,a.projectionTranslateX=this.options.projectionTranslateX,a.projectionTranslateY=this.options.projectionTranslateY,a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink;var b=this.options;d3.json(b.topojson,function(c,d){d3.json(b.geo_data,function(b,c){a.render(d,c)})})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.topojson?!1:void 0===this.options.geo_data?!1:void 0===this.options.width?!1:void 0===this.options.height?!1:void 0===this.options.colorscale?!1:void 0===this.options.colorcode?!1:!0},this.options=jQuery.extend({scale:5,initScale:1},a),this.render=function(a,b){var c=this;$(this.options.selection).html("");var d;if("ordinal"==c.cs){for(d in b)c.color_domain.push(b[d].data);c.max=d3.max(c.color_domain)}else if("selector"==c.cs){for(d in b);c.objkey=d;var e=Object.keys(b[c.objkey]);c.param=e[0]}this.legends_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choroplethOneLayer-legend-holder").attr("height",50).attr("width",c.w),this.map_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choroplethOneLayer-map-holder").attr("width",c.w).attr("height",c.h-100),this.renderTooltip(),this.draw(a,b),renderCredits("pyk-choroplethOneLayer-map-holder",$(".pyk-choroplethOneLayer-map-holder").width(),$(".pyk-choroplethOneLayer-map-holder").height(),c.source_name,c.source_link)},this.renderTooltip=function(){$("#choroplethOneLayer-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","choroplethOneLayer-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.draw=function(a,b){this.renderLegends(a,b),this.renderMaps(a,b,function(){})},this.renderLegends=function(a,b){var c=this;if("ordinal"==c.cs){onetenth=d3.format(".1f")(c.max/10);for(var d=1;10>=d;d++)legend=d3.round(onetenth*(d+.5)),this.legends_group.append("circle").attr("cx",50*d).attr("cy",20).attr("r",5).attr("fill","green").attr("opacity",d/10),this.legends_group.append("text").attr("x",50*d+7).attr("y",24).style("font-size",10).style("font","Arial").text("< "+legend)}else if("selector"==c.cs){var e=Object.keys(b[c.objkey]),f=this.options.width/e.length,g=this.legends_group.selectAll("text").data(e);g.enter().append("text"),g.attr("y",function(a,b){return b>2?40:15}).attr("x",function(a,b){return b>2?(b-3)*f+25:b*f+25}).text(function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}).on("click",function(d){c.param=d,c.draw(a,b)});var h=this.legends_group.selectAll("circle").data(e);h.enter().append("circle"),h.attr("cy",function(a,b){return b>2?35:10}).attr("cx",function(a,b){return b>2?(b-3)*f+15:b*f+15}).attr("r",7).attr("style",function(a){var b=a===c.param?"#000":"#fff";return"stroke-width: 3px; stroke: #000; fill: "+b}).on("click",function(d){c.param=d,c.draw(a,b)})}},this.renderMaps=function(a,b){var c=this,d=d3.geo.mercator().scale(c.projectionScale).translate([c.projectionTranslateX,c.projectionTranslateY]),e=d3.geo.path().projection(d),f=(this.options.initScale*this.options.scale,0),g=0,h=this.map_group;this.map_group.selectAll("g").remove();var i=h.append("g").attr("class","states"),j=i.selectAll("path").data(topojson.feature(a,a.objects.collection).features).enter().append("path").attr("d",e).attr("data-id",function(a){return a.id}).attr("transform",function(){return"scale("+c.options.initScale+")"}).attr("class",function(a){return a.id}).on("mouseover",function(a){for(var d in b)if(d==a.id){var e;e="selector"==c.cs?b[d][c.param].tooltip:b[d].tooltip,c.tooltip.html(e),c.tooltip.style("visibility","visible");break}}).on("mousemove",function(){var a=parseInt(c.tooltip.style("height"))+40,b=parseInt(c.tooltip.style("width"))/2;c.tooltip.style("top",event.pageY-a+"px").style("left",event.pageX-b+"px")}).on("mouseout",function(){c.tooltip.style("visibility","hidden")});"selector"==c.cs?j.attr("data-heat",function(a){return b[a.id]?b[a.id][c.param].data?b[a.id][c.param].data/100:1:1}).attr("data-color",function(a){return b[a.id]?b[a.id][c.param].color:"black"}).attr("style",function(a){if(b[a.id]){var d;d="population"==c.param?"#5fa9d5":"growth_rate"==c.param?"#a3c337":"sex_ratio"==c.param?"#feaf45":"literacy"==c.param?"#e63240":"#af78be";var e=1;return b[a.id][c.param].data&&(e=c.colorOpacity(b,b[a.id][c.param].data)),"fill: "+d+"; opacity: "+e}}):j.attr("fill",function(a){if("linear"==c.cs){for(var d in b)if(d==a.id)return b[d].color}else if("ordinal"==c.cs)return c.cc}).attr("opacity",function(a){if("linear"==c.cs)return 1;if("ordinal"==c.cs){for(var d in b)if(d==a.id)return f++,c.colorOpacity(b,b[d].data);if(g++,f!=g)return f++,.1}})},this.colorOpacity=function(a,b){var c=this;return"selector"==c.cs?(geomin=_.min(a,function(b,d){return a[d][c.param].data})[c.param].data,geomax=_.max(a,function(b,d){return a[d][c.param].data})[c.param].data,diff=geomax-geomin,onetenth=+d3.format(".2f")(diff/10),opacity=(b-geomin+onetenth)/diff):(opacity=d3.format(".1f")(b/c.max),0===opacity&&(opacity=.1)),opacity},this},PykCharts.linearRangeQuery=function(a){this.execute=function(){var b=this;width=this.options.width,height=this.options.height,b.nonchartColumns=this.options.nonchartColumns,b.imageColumns=this.options.imageColumns,b.linkColumns=this.options.linkColumns,b.source_name=this.options.sourceName,b.source_link=this.options.sourceLink,d3.csv(a.data,function(a,c){b.data=c,b.render(),b.renderTooltip()})},this.options=jQuery.extend({width:550,height:400},a),this.render=function(){function b(a,b,c){c&&(b.strokeStyle=c),b.beginPath();var d=0,e=0;g.map(function(c,f){var g=k(c),h=l[c](a[c]);if(0===f)b.moveTo(g,h);else{var i=g-.85*(g-d),j=e,m=g-.15*(g-d),n=h;b.bezierCurveTo(i,j,m,n,g,h)}d=g,e=h}),b.stroke()}function c(a){o[a]}function d(a){for(var b,c,d=a.length;d;)c=Math.floor(Math.random()*d--),b=a[d],a[d]=a[c],a[c]=b;return a}var e=this;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)};var f,g,h=[60,10,20,0],i=860-h[1]-h[3],j=290-h[0]-h[2],k=d3.scale.ordinal().rangePoints([0,i],1),l={},m=(d3.svg.line(),d3.svg.axis().orient("left")),n=0,o={year:[28,100,52],"Below 18 Years":[214,55,79],"Between 18-30 Years":[185,56,73],"Between 30-45 Years":[30,100,73],"Between 45-60 Years":[359,69,49],"Above 60 Years":[110,57,70],Total:[120,56,40]};d3.select("#chart").attr("class","linear-range-query").style("width",i+h[1]+h[3]+"px").style("height",j+h[0]+h[2]+"px"),d3.selectAll("canvas").attr("class","linear-range-query").attr("width",i).attr("height",j).style("padding",h.join("px ")+"px"),d3.select("#hide-ticks").on("click",function(){d3.selectAll(".axis g").style("display","none"),d3.selectAll(".axis path").style("display","none")}),d3.select("#show-ticks").on("click",function(){d3.selectAll(".axis g").style("display","block"),d3.selectAll(".axis path").style("display","block")}),d3.select("#dark-theme").on("click",function(){d3.select("body").attr("class","dark")}),d3.select("#light-theme").on("click",function(){d3.select("body").attr("class",null)}),f=document.getElementById("foreground").getContext("2d"),f.strokeStyle="rgba(0,100,160,0.1)",f.lineWidth=1.3,f.fillText("Loading...",i/2,j/2);var p=d3.select("svg").attr("class","linear-range-query").attr("width",i+h[1]+h[3]).attr("height",j+h[0]+h[2]).append("svg:g").attr("transform","translate("+h[3]+","+h[0]+")");d3.csv(a.data,function(a){function h(){n++;var b=g.filter(function(a){return!l[a].brush.empty()}),c=b.map(function(a){return l[a].brush.extent()}),d=[];a.map(function(a){return b.every(function(b,d){return c[d][0]<=a[b]&&a[b]<=c[d][1]})?d.push(a):null}),o(d,f,n)}function o(a,g,h){function k(){var d=d3.min([m+12,l]);a.slice(m,d).forEach(function(a){b(a,f,c(a.group,o))}),m=d,d3.select("#rendered-count").text(m)}var l=a.length,m=0,o=d3.min([2/Math.pow(l,.37),1]);d3.select("#selected-count").text(l),d3.select("#opacity").text((""+o).slice(0,6)),a=d(a),d3.select("table").remove();var p=_.keys(a[0]),q=d3.select("#wrap-table").append("table").attr("class","table table-striped table-hover"),r=q.append("thead"),s=q.append("tbody");r.append("tr").selectAll("th").data(p).enter().append("th").text(function(a){return a});{var t=s.selectAll("tr").data(a).enter().append("tr");t.selectAll("td").data(function(a){return p.map(function(b){return{column:b,value:a[b]}})}).enter().append("td").html(function(a){return _.contains(e.imageColumns,a.column)===!0?"<img src='"+a.value+"' />":_.contains(e.linkColumns,a.column)===!0?"<a href='"+a.value.match(/\((.*?)\)/)[1]+"'>"+a.value.match(/\[(.*?)\]/)[1]+"</a>":a.value})}g.clearRect(0,0,i+1,j+1),function u(){m>=l||n>h||(requestAnimFrame(u),k())}()}a=a.map(function(a){for(var b in a)_.contains(e.nonchartColumns,b)===!1&&_.contains(e.imageColumns,b)===!1&&_.contains(e.linkColumns,b)===!1&&(a[b]=parseFloat(a[b])||0);return a}),k.domain(g=d3.keys(a[0]).filter(function(b){return _.contains(e.nonchartColumns,b)===!1&&_.contains(e.imageColumns,b)===!1&&_.contains(e.linkColumns,b)===!1&&(l[b]=d3.scale.linear().domain(d3.extent(a,function(a){return+a[b]})).range([j,0]))})),o(a,f,n);var q=p.selectAll(".dimension").data(g).enter().append("svg:g").attr("class","dimension").attr("transform",function(a){return"translate("+k(a)+")"});q.append("svg:g").attr("class","axis").each(function(a){d3.select(this).call(m.scale(l[a]))}).append("svg:text").attr("text-anchor","left").attr("y",-8).attr("x",-4).attr("transform","rotate(-19)").attr("class","label").text(String),q.append("svg:g").attr("class","brush").each(function(a){d3.select(this).call(l[a].brush=d3.svg.brush().y(l[a]).on("brush",h))}).selectAll("rect").attr("x",-16).attr("width",32).attr("rx",3).attr("ry",3),renderCredits("linear-range-query",$(".linear-range-query").width(),$(".linear-range-query").height(),e.source_name,e.source_link)})},this.renderTooltip=function(){$("#pyk-wrap").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-wrap").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")}},PykCharts.BubblePack=function(a){this.execute=function(){var b=this;b.source_name=a.sourceName,b.source_link=a.sourceLink,d3.json(a.data,function(a,c){b.data=c,b.render(),b.renderTooltip()})},this.render=function(){function b(a){function b(a,d){d.children?d.children.forEach(function(a){b(d.name,a)}):c.push({packageName:a,className:d.name,value:d.size,tip:d.ttip,color:d.colors})}var c=[];return b(null,a),{children:c}}{var c=this,d=600,e=d3.format(",d"),f=d3.scale.category20c(),g=d3.layout.pack().sort(null).size([d,d]).padding(1.5),h=d3.select(a.selection).append("svg").attr("width",d).attr("height",d).attr("class","bubble");d3.scale.linear().domain([0,1e4]).range([0,d])}d3.json(a.data,function(a,d){var i=h.selectAll(".node").data(g.nodes(b(d)).filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});i.append("title").text(function(a){return a.className+": "+e(a.value)}),i.append("circle").attr("r",function(a){return a.r}).on("mouseover",function(a){return c.tooltip.html(a.tip).style("visibility","visible")}).on("mousemove",function(){return c.tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return c.tooltip.style("visibility","hidden")}).style("fill",function(a){return f(a.packageName)}),i.append("text").attr("dy",".3em").style("text-anchor","middle").text(function(a){return a.className.substring(0,a.r/3)})}),d3.select(self.frameElement).style("height",d+"px"),renderCredits("bubble",$(".bubble").width(),$(".bubble").height(),c.source_name,c.source_link)},this.renderTooltip=function(){$("#pyk-bubble-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-bubble-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")}},PykCharts.Chord=function(a){return this.execute=function(){if(!this.validate_options())return!1;var a=this;a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink,d3.json(a.options.relations,function(b,c){a.relations=c,d3.json(a.options.frequency,function(b,c){a.frequency=c,a.render()})})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.relations?!1:void 0===this.options.frequency?!1:!0},this.options=jQuery.extend({width:700,height:500},a),this.render=function(){var a=this;this.nicks=this.frequency.map(function(a){return a.nick}),this.color=this.frequency.map(function(a){return a.color}),this.generateMatrix(),this.renderChord(),renderCredits("pyk-chord-credits",$(".pyk-chord-credits").width(),$(".pyk-chord-credits").height(),a.source_name,a.source_link)},this.renderChord=function(){function a(a){return function(b,c){var d,e=[],g=[];0===a?($(".spinning").css("-webkit-animation-play-state","paused"),$(".spinning").css("animation-play-state","paused")):($(".spinning").css("-webkit-animation-play-state","running"),$(".spinning").css("animation-play-state","runnin")),f.selectAll("g.chord path").filter(function(a,b){return d=a.target.index,e[b]=a.source.index,a.source.index!=c&&a.target.index!=c}).transition().style("opacity",a),f.selectAll("g.chordname text").filter(function(a){return c==d||c==d-1||c==d-2||c==d-3||c==d-4||c==d-5||c==d-6||c==d-7||c==d-8||c==d-9?($.each(e,function(a,b){-1===$.inArray(b,g)&&g.push(b)}),a.index!=c&&a.index!=g[0]&&a.index!=g[1]&&a.index!=g[2]&&a.index!=g[3]&&a.index!=g[4]&&a.index!=g[5]&&a.index!=g[6]&&a.index!=g[7]&&a.index!=g[8]&&a.index!=g[9]):a.index!=c&&a.index!=d&&a.index!=d-1&&a.index!=d-2&&a.index!=d-3&&a.index!=d-4&&a.index!=d-5&&a.index!=d-6&&a.index!=d-7&&a.index!=d-8&&a.index!=d-9}).transition().style("opacity",a)}}var b=this,c=this.options.height,d=this.options.width,e="";e=1==this.options.spinning?"pyk-chord spinning":"pyk-chord";var f=d3.select(this.options.selection).append("svg").attr("class",e).attr("width",d).attr("height",c).append("g").attr("transform","translate("+d/2+","+c/2+")"),g=(d3.scale.ordinal().range([b.options.color]),.31*Math.min(d,c)),h=1.1*g,i=d3.layout.chord().padding(.05).sortSubgroups(d3.descending).matrix(b.matrix);f.append("g").attr("class","circumference").selectAll("path").data(i.groups).enter().append("path").style("fill",function(a){return b.color[a.index]}).style("stroke",function(a){return b.color[a.index]}).attr("d",d3.svg.arc().innerRadius(g).outerRadius(h)).on("mouseover",a(0)).on("mouseout",a(1)),f.append("g").attr("class","chord").selectAll("path").data(i.chords).enter().append("path").style("fill",function(a){return b.color[a.target.index]}).attr("d",d3.svg.chord().radius(g)).style("opacity",1);var j=f.append("svg:g").attr("class","chordname").selectAll("g").data(i.groups).enter().append("svg:g").attr("transform",function(a){return"rotate("+(180*a.startAngle/Math.PI-90)+")translate("+h+",0)"});j.append("svg:text").attr("x",8).attr("dy",".35em").attr("fill",function(a){return b.color[a.index]}).attr("text-anchor",function(a){return a.angle>Math.PI?"end":null}).attr("transform",function(a){return a.angle>Math.PI?"rotate(180)translate(-16)":null}).text(function(a){return b.nicks[a.index]}),d3.select(this.options.selection).append("svg").attr("class","pyk-chord-credits").attr("width",d).attr("height",10)},this.generateMatrix=function(){function a(){for(var a=0;a<b.nicks.length;a++){c[a]=[];for(var d=0;d<b.nicks.length;d++)c[a][d]=0}}var b=this,c=[];a();for(var d in this.relations){var e=this.relations[d];c[b.nicks.indexOf(e.from)][b.nicks.indexOf(e.to)]=e.messages}this.matrix=c},this},PykCharts.Choropleth=function(a){var b=[20,30,40,50,60,70,80,90],c=[20,30,40,50,60,70,80,90],d=["< 20","30+","40+","50+","60+","70+","80+","> 90"],e=d3.scale.threshold().domain(b).range(["#79C7FC","#6BBDF4","#5DB2EA","#53A4DB","#4A99CE","#4293C9","#3788BF","#2E82BA","#1F77B4"]),f=d3.scale.threshold().domain(b).range(["#79F779","#6FED6F","#64E564","#5CDB5C","#52CE52","#4AC44A","#3FB53F","#37AD37","#42A142"]);return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='https://s3.amazonaws.com/PykCharts/spinner.gif'> Loading... Please wait");var a=this;a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink;var b=this.options;d3.json(b.topojson,function(c,d){d3.json(b.state_data,function(c,e){d3.json(b.county_data,function(b,c){a.render(d,e,c)})})})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.topojson?!1:void 0===this.options.county_data?!1:void 0===this.options.state_data?!1:!0},this.options=jQuery.extend({width:960,height:400,scale:5,initScale:.6},a),this.render=function(a,b,c){var d=this;$(this.options.selection).html(""),d.h=this.options.height,d.w=this.options.width,this.legends_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-legend-holder").attr("height",30).attr("width",d.w),this.map_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-map-holder").attr("height",d.h-100).attr("width",d.w),this.downlegend_group=d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-downlegends-holder").attr("height",50).attr("width",d.w),this.downlegend_group1=d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-downlegends-holder1").attr("height",50).attr("width",d.w);var e=Object.keys(b["0"]);this.param=e[0],this.renderTooltip(),this.draw(a,b,c),$("body").find(" .pyk-choropleth-downlegends-holder1").hide(),renderCredits("pyk-choropleth-credits",$(".pyk-choropleth-credits").width(),$(".pyk-choropleth-credits").height(),d.source_name,d.source_link)},this.renderTooltip=function(){$("#choropleth-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","choropleth-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.draw=function(a,b,c){this.renderLegends(a,b,c),this.renderMaps(a,b,c,function(){})},this.renderLegends=function(a,b,c){var d=this,e=Object.keys(b["0"]),f=this.options.width/e.length,g=this.legends_group.selectAll("text").data(e);g.enter().append("text"),g.attr("y",15).attr("x",function(a,b){return b*f+25}).text(function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}).on("click",function(e){d.param=e,"revenue"==e?($(" .pyk-choropleth-downlegends-holder1").hide(),$(" .pyk-choropleth-downlegends-holder").show()):($(" .pyk-choropleth-downlegends-holder1").css("display","block"),$(" .pyk-choropleth-downlegends-holder1").show(),$(" .pyk-choropleth-downlegends-holder").hide()),d.draw(a,b,c)});var h=this.legends_group.selectAll("circle").data(e);h.enter().append("circle"),h.attr("cy",10).attr("cx",function(a,b){return b*f+15}).attr("r",7).attr("style",function(a){var b=a===d.param?"#000":"#fff";return"stroke-width: 3px; stroke: #000; fill: "+b}).on("click",function(e){d.param=e,"revenue"==e?($(" .pyk-choropleth-downlegends-holder1").hide(),$(" .pyk-choropleth-downlegends-holder").show()):($(" .pyk-choropleth-downlegends-holder").hide(),$(" .pyk-choropleth-downlegends-holder1").show()),d.draw(a,b,c)})},this.renderMaps=function(a,b,g){var h=this,i=d3.geo.path(),j=this.options.initScale*this.options.scale,l=this.options.height,m=this.options.width,n=this.param,o=this.map_group;this.map_group.selectAll("g").remove();var p=o.append("g").attr("class","counties"),q=o.append("g").attr("class","states"),r=this.downlegend_group1.selectAll("g.legend").data(c).enter().append("g").attr("class","legend"),s=60,t=7;r.append("rect").attr("x",function(a,b){return s*b}).attr("y",20).attr("width",s).attr("height",t).style("fill",function(a){return f(a)}).style("opacity",.8),r.append("text").attr("x",function(a,b){return s*b}).attr("y",40).attr("class","mono").text(function(a,b){return d[b]}),p.selectAll("path").data(topojson.feature(a,a.objects.counties).features).enter().append("path").attr("class","county").attr("d",i).attr("style",function(a){if(g[a.id]){var b=g[a.id][n].color,c=1;return g[a.id][n].data&&(c=g[a.id][n].data/100),"fill: "+b+"; opacity: "+c}}).attr("data-id",function(a){return a.id}).attr("transform",function(){return"scale("+h.options.initScale+")"}).on("click",function(){var a,b,c;a=m/2,b=l/2,c=1,q.transition().ease("back").duration(1200).attr("transform","translate("+m/2+","+l/2+")scale("+c+")translate("+-a+","+-b+")"),p.transition().ease("back").duration(1200).attr("transform","translate("+m/2+","+l/2+")scale("+c+")translate("+-a+","+-b+")"),$("g.counties").fadeOut(),$("g.states path").css("fill",function(){return $(this).attr("data-color")}),$("g.states path").css("opacity",function(){return $(this).attr("data-heat")})}).on("mouseover",function(a){if(g[a.id]){var b=g[a.id][n].tooltip;h.tooltip.html(b),h.tooltip.style("visibility","visible")}}).on("mousemove",function(){var a=parseInt(h.tooltip.style("height"))+40,b=parseInt(h.tooltip.style("width"))/2;h.tooltip.style("top",d3.event.pageY-a+"px").style("left",d3.event.pageX-b+"px")}).on("mouseout",function(){h.tooltip.style("visibility","hidden")}),q.selectAll("path").data(topojson.feature(a,a.objects.states).features).enter().append("path").attr("class","state").attr("d",i).attr("data-heat",function(a){return b[a.id]?b[a.id][n].data?b[a.id][n].data/100:1:1}).attr("data-color",function(a){return b[a.id]?b[a.id][n].color:"black"}).attr("data-id",function(a){return a.id}).attr("transform",function(){return"scale("+h.options.initScale+")"}).attr("style",function(a){if(b[a.id]){var c=b[a.id][n].color,d=1;return b[a.id][n].data&&(d=b[a.id][n].data/100),"fill: "+c+"; opacity: "+d}}).on("click",function(a){var b=i.centroid(a),c=b[0]*h.options.initScale,d=b[1]*h.options.initScale;k=j,p.transition().delay(250).ease("elastic").duration(1200).attr("transform","translate("+m/2+","+l/2+")scale("+k+")translate("+-c+","+-d+")"),q.transition().delay(250).ease("elastic").duration(1200).attr("transform","translate("+m/2+","+l/2+")scale("+k+")translate("+-c+","+-d+")"),$("g.states path").css("fill","#fff"),$(this).css("fill","none"),$("g.states path").animate({opacity:.9}),$("g.counties").show()}).on("mouseover",function(a){if(g[a.id]){var c=b[a.id][n].tooltip;h.tooltip.html(c),h.tooltip.style("visibility","visible")}}).on("mousemove",function(){var a=parseInt(h.tooltip.style("height"))+40,b=parseInt(h.tooltip.style("width"))/2;h.tooltip.style("top",d3.event.pageY-a+"px").style("left",d3.event.pageX-b+"px")}).on("mouseout",function(){h.tooltip.style("visibility","hidden")});var u=this.downlegend_group.selectAll("g.legend").data(c).enter().append("g").attr("class","legend");s=60,t=7,u.append("rect").attr("x",function(a,b){return s*b}).attr("y",20).attr("width",s).attr("height",t).style("fill",function(a){return e(a)}).style("opacity",.8),u.append("text").attr("x",function(a,b){return s*b}).attr("y",40).attr("class","mono").text(function(a,b){return d[b]}),$("g.counties").hide(),d3.select(this.options.selection).append("svg").attr("class","pyk-choropleth-credits").attr("width",h.w).attr("height",10)},this},PykCharts.GoogleHeat=function(a){return this.execute=function(){if(!this.validate_options())return!1;this.container=$(this.options.selection),this.div=$("<div>").css("height",this.options.height+"px").css("width",this.options.width+"px"),this.container.append(this.div);var a=this;a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink,$.getJSON(this.options.data,function(b){a.data=b,a.render()})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.data?!1:!0},this.options=jQuery.extend({width:960,height:500,center:new google.maps.LatLng(-25.363882,131.044922),defaultZoom:3,tooltipZoom:4},a),this.render=function(){var a=this,b=this.div.get(0),c={center:this.options.center,zoom:this.options.defaultZoom,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(b,c),this.map.setOptions({styles:this.setupStyle()}),this.setupHeat(),this.setupMarkers(),renderCredits("pyk-googlemap-credits",$(".pyk-googlemap-credits").width(),$(".pyk-googlemap-credits").height(),a.source_name,a.source_link)},this.setupStyle=function(){return[{stylers:[{hue:"#FFBB78"},{visibility:"simplified"},{gamma:.5},{weight:.5}]},{elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"water",stylers:[{color:"#1F77B4"}]}]},this.setupHeat=function(){var a=new google.maps.MVCArray(this.heatData()),b=new google.maps.visualization.HeatmapLayer({data:a});b.setMap(this.map),d3.select(this.options.selection).append("svg").attr("class","pyk-googlemap-credits").attr("width",this.options.width).attr("height",10)},this.setupMarkers=function(){var a=this,b=new MarkerManager(a.map),c=[];for(var d in this.data){var e=this.data[d],f=new google.maps.Marker({position:new google.maps.LatLng(e.latitude,e.longitude),title:e.tooltip,icon:e.marker});c.push(f);var g=new google.maps.InfoWindow({content:e.tooltip});google.maps.event.addListener(f,"click",function(b){return function(){b.open(a.map,this)}}(g))}google.maps.event.addListener(b,"loaded",function(){b.addMarkers(c,a.options.tooltipZoom),b.refresh()})},this.heatData=function(){var a=[];for(var b in this.data){var c=this.data[b],d=new google.maps.LatLng(c.latitude,c.longitude);a.push({location:d,weight:c.count})}return a},this},PykCharts.BubbleMap=function(a){this.execute=function(){var b=this;b.source_name=a.sourceName,b.source_link=a.sourceLink,d3.csv(a.data1,function(c){b.extractFile1(c),d3.csv(a.data2,function(a){b.extractFile2(a),b.render(b),b.renderTooltip()})})},this.render=function(b){var c="#BD8D46",d="#B9121B",e="#4C1B1B",f="#F6E497",g="#FCFAE1",h=parseInt($(a.selection).css("width")),i=parseInt($(a.selection).css("height"))||screen.availHeight,j=h/screen.availWidth,k=d3.select(a.selection).append("svg").attr("width",h).attr("height",60),l=d3.select(a.selection).append("svg").attr("class","pyk-onelayerbubblemap").attr("width",h).attr("height",i);k.append("text").text("Gross Domestic Product").attr("x",50).attr("y",35);var m=k.append("g").attr("transform","translate("+parseInt(h-400)+",15)");m.append("circle").attr("cx",100).attr("cy",15).attr("r",5).attr("fill",e),m.append("text").text("GDP").attr("x",120).attr("y",20),m.append("circle").attr("cx",200).attr("cy",15).attr("r",5).attr("fill",d),m.append("text").text("Undefined").attr("x",220).attr("y",20);var n=d3.geo.mercator().scale(200*j).translate([h/2,i/2]),o=d3.geo.path().projection(n),p=d3.scale.linear().domain([b.gdp1Values[0],b.gdp1Values[b.gdp1Values.length-1]]).range([1,10]),q=d3.scale.linear().domain([b.gdp2Values[0],b.gdp2Values[b.gdp2Values.length-1]]).range([.1,1]);d3.json("res/data/world.json",function(a,h){var i=l.selectAll("path").data(topojson.feature(h,h.objects.subunits).features).enter().append("path").attr("d",o).attr("fill",g).style("opacity",1).on("mouseover",function(a){var c=d3.select("#world-tooltip");c.html("<div> Dataset2 </div><div><div>"+a.properties.name+"</div><div>"+b.file2gdp[a.properties.id]+"</div>"),c.style("visibility","visible")}).on("mousemove",function(){var a=d3.select("#world-tooltip"),b=parseInt(a.style("height"))+40,c=parseInt(a.style("width"))/2;a.style("top",d3.event.pageY-b+"px").style("left",d3.event.pageX-c+"px")}).on("mouseout",function(){var a=d3.select("#world-tooltip");a.style("visibility","hidden")}),k=l.selectAll("circle").data(topojson.feature(h,h.objects.subunits).features).enter().append("circle").attr("r",0).attr("cx",function(a){return o.centroid(a)[0]}).attr("cy",function(a){return o.centroid(a)[1]}).attr("fill",c).attr("stroke",f).on("mouseover",function(a){var c=d3.select("#world-tooltip");c.html("<div> Dataset1 </div><div>"+a.properties.name+"</div><div>"+b.file1gdp[a.properties.id]+"</div>"),c.style("visibility","visible")}).on("mousemove",function(){var a=d3.select("#world-tooltip"),b=parseInt(a.style("height"))+40,c=parseInt(a.style("width"))/2;a.style("top",d3.event.pageY-b+"px").style("left",d3.event.pageX-c+"px")}).on("mouseout",function(){var a=d3.select("#world-tooltip");a.style("visibility","hidden")});i.transition().delay(0).duration(1e3).ease("bounce").attr("fill",function(a){return b.file2gdp[a.properties.id]?e:d}).style("opacity",function(a){return q(b.file2gdp[a.properties.id])?q(b.file2gdp[a.properties.id]):1}),k.transition().delay(2e3).duration(3e3).ease("bounce").attr("r",function(a){return b.file1gdp[a.properties.id]?p(b.file1gdp[a.properties.id])*j:0})}),d3.select(a.selection).append("svg").attr("class","pyk-onelayerbubblemap-credits").attr("width",h).attr("height",10),renderCredits("pyk-onelayerbubblemap-credits",$(".pyk-onelayerbubblemap-credits").width(),$(".pyk-onelayerbubblemap-credits").height(),b.source_name,b.source_link)},this.renderTooltip=function(){$("#world-tooltip").remove(),d3.select(a.selection).append("div").attr("id","world-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.extractFile1=function(a){this.file1gdp=[],this.gdp1Values=[];for(var b=0;b<a.length;++b)this.file1gdp[a[b].CountryCode]=a[b].GDP,this.gdp1Values[b]=a[b].GDP},this.extractFile2=function(a){this.file2gdp=[],this.gdp2Values=[];for(var b=0;b<a.length;++b)this.file2gdp[a[b].CountryCode]=a[b].GDP,this.gdp2Values[b]=a[b].GDP}},PykCharts.compare_with_circles=function(a){function b(a,b,c){return a.length>b&&(a=a.substring(0,b+1),a=a.substring(0,Math.min(a.length,a.lastIndexOf(" "))),a+=c),a}var c=this;c.source_name=a.sourceName,c.source_link=a.sourceLink;var d={top:20,right:200,bottom:0,left:20},e=a.width,f=a.height,g=2001,h=2012,i=d3.scale.linear().range([0,e]),j=d3.svg.axis().scale(i).ticks(5).orient("top"),k=d3.format("0000");j.tickFormat(k);var l=d3.select(a.selection).append("svg").attr("class","pyk-compare_with_circles").attr("width",e+d.left+d.right).attr("height",f+d.top+d.bottom).style("margin-left",d.left+"px").append("g").attr("transform","translate("+d.left+","+d.top+")");
d3.json(a.data,function(a){function c(){var a=d3.select(this).node().parentNode;d3.select(a).selectAll("circle").style("display","none"),d3.select(a).selectAll("text.value").style("display","block")}function d(){var a=d3.select(this).node().parentNode;d3.select(a).selectAll("circle").style("display","block"),d3.select(a).selectAll("text.value").style("display","none")}i.domain([g,h]);var f=d3.scale.linear().domain([g,h]).range([0,e]);l.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(j);for(var k=0;k<a.length;k++){var m=l.append("g").attr("class","first row"),n=m.selectAll("circle").data(a[k].collection).enter().append("circle"),o=m.selectAll("text").data(a[k].collection).enter().append("text"),p=d3.scale.linear().domain([0,d3.max(a[k].collection,function(a){return a[1]})]).range([2,12]);n.attr("cx",function(a){return f(a[0])}).attr("cy",30*k+30).attr("r",function(a){return p(a[1])}).style("fill",a[k].color).style("opacity",.1*a[k].opacity),o.attr("y",30*k+35).attr("x",function(a){return f(a[0])-5}).attr("class","value").text(function(a){return a[1]}).style("fill",a[k].color).style("opacity",.1*a[k].opacity).style("display","none"),m.append("text").attr("y",30*k+35).attr("x",e+40).attr("class","label1").text(b(a[k].name,30,"...")).style("fill",a[k].color).style("opacity",.1*a[k].opacity).on("mouseover",c).on("mouseout",d)}}),renderCredits("pyk-compare_with_circles",$(".pyk-compare_with_circles").width(),$(".pyk-compare_with_circles").height(),c.source_name,c.source_link)},PykCharts.River=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='https://s3.amazonaws.com/PykCharts/spinner.gif'> Loading... Please wait");var a=this;a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink;var b=this.options;d3.json(b.data,function(b,c){a.data=c,a.render()})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.data?!1:this.options.width<300?!1:!0},this.options=jQuery.extend({width:960,height:200,filterList:[],fullList:[],extended:!1},a),this.render=function(){var a=this;$(this.options.selection).html("");var b=this.options.height,c=this.options.width;this.svg=d3.select(this.options.selection).append("svg").attr("class","pyk-river").attr("height",b+20).attr("width",c),this.legends_group=this.svg.append("g").attr("class","legend-holder").attr("transform","translate(0,15)"),this.map_group=this.svg.append("g").attr("class","map-holder"),this.renderTooltip(),this.draw(),renderCredits("pyk-river",$(".pyk-river").width(),$(".pyk-river").height(),a.source_name,a.source_link)},this.renderTooltip=function(){$("#river-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","river-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.draw=function(){this.renderLegends(),this.renderChart()},this.renderLegends=function(){var a=this,b=(this.legends_group.append("g").attr("class","option-holder").attr("transform","translate(0,15)"),[{name:"Percentage",on:this.extended},{name:"Absolute",on:!this.extended}]),c=this.legends_group.select("g.option-holder").selectAll("text").data(b);c.enter().append("text").text(function(a){return a.name}).attr("transform",function(a,b){return"translate("+(100*b+20)+",0)"}).on("click",function(){a.extended=!a.extended,a.draw()});var d=this.legends_group.select("g.option-holder").selectAll("circles").data(b);d.enter().append("circle").attr("cx",function(a,b){return 100*b+10}).attr("cy",-6).attr("r",6).attr("style",function(a){var b=a.on?"#000":"#fff";return"fill: "+b+"; stroke-width: 3px; stroke:#000"}).on("click",function(){a.extended=!a.extended,a.draw()});var e=this.data[0].breakup,f=(this.options.width-250)/e.length,g=this.legends_group.append("g").attr("class","legend-holder").attr("transform","translate(250,15)");g.selectAll("g.legend").data(e).enter().append("g").attr("class","legend").attr("transform",function(a,b){var c=b*f;return"translate("+c+",0)"}).on("click",function(b){a.toggleFilter(b.name)});var h=d3.selectAll("g.legend")[0];for(var i in e){var j=d3.select(h[i]);j.selectAll("text").data([e[i]]).enter().append("text").text(function(b){return a.options.filterList.push(b.name),a.options.fullList.push(b.name),b.name}).attr("transform","translate(20,-1)");var k=j.selectAll("circle").data([e[i]]);k.enter().append("circle"),k.attr("cx",9).attr("cy",-6).attr("r",6).attr("style",function(b){var c=-1===a.options.filterList.indexOf(b.name)?"#fff":b.color;return 0===a.options.filterList.length&&(c=b.color),"fill: "+c+"; stroke-width: 3px; stroke:"+b.color})}},this.renderChart=function(){var a=jQuery.extend(!0,[],this.data),b=40,c=this;a=this.filter(a),a=this.parseData(a);var d=this.maxTotal(a),e=this.options.width,f=this.options.height,g=d3.scale.linear().domain([0,d]).range([0,e-200]),h=d3.scale.linear().domain([0,f]).range([b,f]),i=f/(2*a.length),j=2*i,k=this.map_group;k.selectAll("line.top_line").data(a).enter().append("line").attr("class","top_line").attr("x1",0).attr("x2",e).attr("y1",function(a,b){return h(b*j)}).attr("y2",function(a,b){return h(b*j)}),k.selectAll("line.bottom_line").data(a).enter().append("line").attr("class","bottom_line").attr("x1",0).attr("x2",e).attr("y1",function(a,b){return h(b*j+i)}).attr("y2",function(a,b){return h(b*j+i)});var l=k.selectAll("g.bar-holder").data(a);l.enter().append("g").attr("class","bar-holder").attr("transform",function(a,b){var c=h(b*j),e=g((d-a.breakupTotal)/2)+100;return"translate("+e+","+c+")"}),l.transition().duration(1e3).attr("height",h(i)).attr("width",function(a){return g(a.breakupTotal)}).attr("transform",function(a,b){var f=h(b*j),i=g((d-a.breakupTotal)/2)+100,k=1,l=1;if(c.extended){var m=g(a.breakupTotal);k=(e-200)/m,l=2,i=h(100)}return"translate("+i+","+f+") scale("+k+", "+l+")"}),l.exit().remove();var m=k.selectAll("g.bar-holder")[0];for(var n in a){var o=m[n],p=a[n].breakup,q=d3.select(o).selectAll("rect").data(p);q.enter().append("rect").attr("width",0),q.transition().duration(1e3).attr("x",function(a,b){if(0===b)return 0;for(var c=0,d=0;b>d;d++)c+=p[d].count;return g(c)}).attr("y",0).attr("height",function(){return i*(f-b)/f}).attr("width",function(a){return g(a.count)}),q.attr("style",function(a){return"fill: "+a.color}).on("mouseover",function(a){var b=d3.select("#river-tooltip");b.html(a.tooltip),b.style("visibility","visible")}).on("mousemove",function(){var a=d3.select("#river-tooltip"),b=parseInt(a.style("height"))+40,c=parseInt(a.style("width"))/2;a.style("top",d3.event.pageY-b+"px").style("left",d3.event.pageX-c+"px")}).on("mouseout",function(){var a=d3.select("#river-tooltip");a.style("visibility","hidden")}).on("click",function(a){c.onlyFilter(a.name)}),q.exit().transition().duration(1e3).attr("width",0).remove()}var r=k.selectAll("text.cool_label").data(a);r.enter().append("text").attr("class","cool_label"),r.attr("x",e).attr("y",function(a,b){return h(b*j+i/2+5)}).text(function(a){return a.breakupTotal+" "+a.technical_name});var s=k.selectAll("text.left_label").data(a);s.enter().append("svg:text").attr("class","left_label"),s.attr("y",function(a,b){return h(b*j+i/2+5)}).attr("x",0).text(function(a){return a.display_name});var t=k.selectAll("text.right_label").data(a);if(t.enter().append("svg:text").attr("class","right_label"),t.attr("y",function(a,b){return h(b*j+1.5*i+5)}).attr("x",e).text(function(b,c){return void 0===a[c+1]?"":b.duration}),this.extended)return $("line.left_line").fadeOut(),$("line.right_line").fadeOut(),void 0;var u=k.selectAll("line.left_line").data(a);u.enter().append("line").attr("class","left_line").attr("y2",function(a,b){return h(b*j+i)}).attr("x2",function(a){return g((d-a.breakupTotal)/2)+100}),u.transition().duration(1e3).attr("style",function(b,c){return a[c+1]?void 0:"stroke-width: 0"}).attr("y1",function(a,b){return h(b*j+i)}).attr("x1",function(a){return g((d-a.breakupTotal)/2)+100}).attr("y2",function(a,b){return h((b+1)*j)}).attr("x2",function(b,c){return a[c+1]?g((d-a[c+1].breakupTotal)/2)+100:0});var v=k.selectAll("line.right_line").data(a);v.enter().append("line").attr("class","right_line").attr("y2",function(a,b){return h(b*j+i)}).attr("x2",function(a){return g((d-a.breakupTotal)/2+a.breakupTotal)+100}),v.transition().duration(1e3).attr("style",function(b,c){return a[c+1]?void 0:"stroke-width: 0"}).attr("y1",function(a,b){return h(b*j+i)}).attr("x1",function(a){return g((d-a.breakupTotal)/2+a.breakupTotal)+100}).attr("y2",function(a,b){return h((b+1)*j)}).attr("x2",function(b,c){return a[c+1]?g((d-a[c+1].breakupTotal)/2+a[c+1].breakupTotal)+100:0})},this.filter=function(a){this.options.filterList.length<1&&(this.options.filterList=jQuery.extend(!0,[],this.options.fullList));for(var b in a){var c=a[b].breakup,d=[];for(var e in c)jQuery.inArray(c[e].name,this.options.filterList)>=0&&d.push(c[e]);a[b].breakup=d}return a},this.onlyFilter=function(a){var b=this.options.filterList.indexOf(a);1===this.options.filterList.length&&-1!=b?this.options.filterList=[]:(this.options.filterList=[],this.options.filterList.push(a)),this.draw()},this.toggleFilter=function(a){var b=this.options.filterList.indexOf(a);-1===b?this.options.filterList.push(a):this.options.filterList.splice(b,1),this.draw()},this.totalInBreakup=function(a){var b=0;for(var c in a)b+=a[c].count;return b},this.maxTotal=function(a){var b=[];for(var c in a)b.push(a[c].breakupTotal);return b=b.sort(function(a,b){return a-b}),b[b.length-1]},this.parseData=function(a){for(var b in a)a[b].breakupTotal=this.totalInBreakup(a[b].breakup);return a},this},PykCharts.treerect=function(a){this.execute=function(){var b=this;width=this.options.width,height=this.options.height,b.source_name=this.options.sourceName,b.source_link=this.options.sourceLink,d3.json(a.data,function(a,c){b.data=c,b.render(),b.renderTooltip()})},this.options=jQuery.extend({width:550,height:400},a),this.render=function(){var b,c,d=this,e=width-60,f=height-135,g=(d3.scale.linear().range([0,e]),d3.scale.linear().range([0,f]),d3.layout.treemap().round(!1).size([e,f]).sticky(!0).value(function(a){return a.size})),h=d3.select(a.selection).append("div").attr("class","chart").style("width",e+"px").style("height",f+"px").append("svg:svg").attr("class","pyk-treerect").attr("width",e).attr("height",f+20).append("svg:g").attr("transform","translate(.5,.5)");d3.json(a.data,function(a){c=b=a;var e=g.nodes(b).filter(function(a){return!a.children}),f=h.selectAll("g").data(e).enter().append("svg:g").attr("class","cell").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});f.append("svg:rect").attr("width",function(a){return a.dx-1}).attr("height",function(a){return a.dy-1}).on("mouseover",function(a){return d.tooltip.html(a.ttip).style("visibility","visible")}).on("mousemove",function(){return d.tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return d.tooltip.style("visibility","hidden")}).style("fill",function(a){return a.colors}),f.append("image").attr("xlink:href",function(a){return a.img}).attr("x",10).attr("y",7).attr("width",17.92).attr("height",16),f.append("svg:text").attr("x",function(a){return a.dx/2}).attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(a){return a.name}).attr("fill","white").style("opacity",function(a){return a.w=this.getComputedTextLength(),a.dx>a.w?1:0})}),renderCredits("pyk-treerect",$(".pyk-treerect").width(),$(".pyk-treerect").height(),d.source_name,d.source_link)},this.renderTooltip=function(){$("#pyk-tree-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-tree-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")}},PykCharts.Ultimate=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='https://s3.amazonaws.com/PykCharts/spinner.gif'> Loading... Please wait");var a=this;a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink,d3.json(this.options.data,function(b,c){a.data=c,a.render()})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.data?!1:this.options.width<300?!1:!0},this.options=jQuery.extend({width:960,height:400,filterList:[],fullList:[],extended:!1,margins:{left:40,right:20,top:10,bottom:80}},a),this.render=function(){var a=this;$(this.options.selection).html("");var b=this.options.height,c=this.options.width;this.svg=d3.select(this.options.selection).append("svg").attr("class","pyk-ultimate "+this.options.selection.substring(1)).attr("height",b+20).attr("width",c),this.svg.append("g").attr("class","yaxis"),this.svg.append("g").attr("class","xaxis"),this.legends_group=this.svg.append("g").attr("class","legend-holder").attr("background","Red").attr("transform","translate(0,15)"),this.chart_group=this.svg.append("g").attr("class","chart-holder").attr("width",c-(this.options.margins.right+this.options.margins.left)).attr("height",b-(this.options.margins.top+this.options.margins.bottom)).attr("transform","translate("+this.options.margins.left+","+this.options.margins.top+")");var d=this.flattenData();this.the_bars=d[0],this.the_keys=d[1],this.the_layers=this.layers(this.the_bars),this.renderTooltip(),this.draw(),renderCredits(this.options.selection.substring(1),$("."+this.options.selection.substring(1)).width(),$("."+this.options.selection.substring(1)).height(),a.source_name,a.source_link)},this.renderLegends=function(){function a(){var a=[];for(var c in b.the_layers)if(b.the_layers[c].name){var d=b.the_layers[c].name,e=b.the_layers[c].values[0].color;a.push({name:d,color:e})}return a}var b=this,c=this.options.width,d=a(),e=this.legends_group.selectAll("g.legend_group").data(d).enter().append("g").attr("class","legend_group").attr("transform",function(a,b){return"translate("+(c-100*b-100)+", 0)"});for(var f in d)var g=d3.select(e[0][f]),h=d[f],i=g.append("text").text(function(){return h.name}).attr("x",function(a,b){return 40*b}).attr("dy",-3),j=g.append("circle").attr("cx",function(a,b){return 100*b-10}).attr("cy",-6).attr("r",6).attr("style",function(a){return"fill: "+a.color+"; stroke-width: 3px; stroke:"+a.color})},this.getGroups=function(){var a={};for(var b in this.the_bars){var c=this.the_bars[b];c.id&&(a[c.group]?a[c.group].push(c.id):a[c.group]=[c.id])}return a},this.renderChart=function(){var a=this,b=this.chart_group.attr("width"),c=this.chart_group.attr("height"),d=this.the_bars,e=this.the_keys,f=this.the_layers,g=this.getGroups(),h=(d3.layout.stack().values(function(a){return a.values})(f),[]);f.map(function(a,b){for(b in a.values){var c=a.values[b];h.push(c.y+c.y0)}});var i=d3.scale.ordinal().domain(d.map(function(a,b){return a.id||b})).rangeBands([0,b],.2),j=d3.scale.linear().domain([0,d3.max(h)]).range([a.options.margins.top,c]).nice(),k=d3.scale.linear().domain([d3.max(h),0]).range([a.options.margins.top,c]).nice(),l=(d3.scale.category10(),d3.svg.axis().scale(k).tickSize(-b,0,0).orient("left")),m=d3.svg.axis().scale(i).tickSize(-c,0,0).tickFormat(function(a){return e[a]?e[a]:void 0}).orient("bottom");this.svg.select("g.yaxis").transition(1e3).attr("transform","translate("+this.options.margins.left+", "+this.options.margins.top+")").call(l);var n=parseInt(this.options.margins.top)+parseInt(c);this.svg.select("g.xaxis").transition(1e3).attr("transform","translate("+this.options.margins.left+", "+n+")").call(m).selectAll("text").style("text-anchor","start").attr("dy","2px").attr("dx","20px").attr("transform",function(){return"rotate(90)"});var o=[];for(var p in g){var q=g[p],r=i(q[0]),s=i.rangeBand()*q.length;r+=s/2,o.push({x:r,name:p})}this.svg.selectAll("text.group_label").data(o).enter().append("text").attr("class","group_label").attr("x",function(b){return b.x+a.options.margins.left}).attr("y",function(){return parseInt(c)+24}).attr("text-anchor","middle").text(function(a){return a.name});var t=this.chart_group.selectAll("g.bars").data(f).enter().append("g").attr("class","bars"),u=t.selectAll("rect").data(function(a){return a.values}).enter().append("svg:rect").attr("height",0).attr("y",c).on("mouseover",function(a){var b=d3.select("#pyk-ultimate-tooltip");b.html(a.tooltip),b.style("visibility","visible")}).attr("fill",function(a){return a.color}).on("mousemove",function(){var a=d3.select("#pyk-ultimate-tooltip"),b=parseInt(a.style("height"))+40,c=parseInt(a.style("width"))/2;a.style("top",d3.event.pageY-b+"px").style("left",d3.event.pageX-c+"px")}).on("mouseout",function(){var a=d3.select("#pyk-ultimate-tooltip");a.style("visibility","hidden")});u.transition().duration(1e3).attr("x",function(a){return i(a.x)}).attr("width",function(){return i.rangeBand()}).attr("height",function(a){return j(a.y)}).attr("y",function(a){return c-j(a.y0+a.y)})},this.draw=function(){this.renderLegends(),this.renderChart()},this.renderTooltip=function(){$("#pyk-ultimate-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-ultimate-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.layers=function(a){function b(a){for(var b in d){var e=d[b];if(e.name==a)return e}return c(a)}function c(a){var b={name:a,values:[]};return d.push(b),b}var d=[];for(var e in a){var f=a[e];if(f.id){var g=f.id;for(var h in f)if("id"!==h){var i=f[h];for(var j in i){var k=i[j];if(k.name){var l=b(k.name);l.values.push({x:g,y:k.val,color:k.color,tooltip:k.tooltip})}}}}}return d},this.flattenData=function(){var a=[-1],b={};for(var c in this.data){var d=this.data[c];for(var e in d){for(var f in d[e]){var g="i"+c+"j"+f,h=Object.keys(d[e][f])[0];b[g]=h,d[e][f].id=g,d[e][f].group=e,a.push(d[e][f])}a.push(c)}}return[a,b]},this},PykCharts.UltimateNegative=function(a){return this.execute=function(){if(!this.validate_options())return!1;$(this.options.selection).html("<img src='https://s3.amazonaws.com/PykCharts/spinner.gif'> Loading... Please wait");var a=this;a.source_name=this.options.sourceName,a.source_link=this.options.sourceLink,d3.json(this.options.data,function(b,c){a.data=c,a.render()})},this.validate_options=function(){return void 0===this.options.selection?!1:void 0===this.options.data?!1:this.options.svg_width<300?!1:!0},this.options=jQuery.extend({barchartwidthadjust:.8,barchartheightadjust:.8,box_gap:10,box_width:10,svg_width:900,svg_height:500,filterList:[],fullList:[],extended:!1,margins:{left:40,right:20,top:10,bottom:80}},a),this.render=function(){var a=this;$(this.options.selection).html("");{var b=this.options.svg_height,c=this.options.svg_width,d=this.options.svg_height*this.options.barchartheightadjust,e=this.options.svg_width*this.options.barchartwidthadjust,f=(b-d)/2;this.options.box_width,this.options.box_gap}this.svg=d3.select(this.options.selection).append("svg").attr("class","pyk-ultimate").attr("height",b).attr("width",c),this.barchartg=this.svg.append("g").attr("transform","translate(0 ,"+f+")").attr("class","barchart").attr("height",d).attr("width",e),this.barchartg.append("g").attr("class","yaxis"),this.barchartg.append("g").attr("class","xaxis"),this.legends_group=this.barchartg.append("g").attr("class","legend-holder").attr("background","Red").attr("transform","translate(100,15)"),this.chart_group=this.barchartg.append("g").attr("class","chart-holder").attr("width",e-(this.options.margins.right+this.options.margins.left)).attr("height",d-(this.options.margins.top+this.options.margins.bottom)).attr("transform","translate("+this.options.margins.left+","+this.options.margins.top+")");var g=this.flattenData(this.data);this.the_bars=g[0],this.the_keys=g[1],this.the_layers=this.layers(this.the_bars),this.renderTooltip(),this.draw(),renderCredits("pyk-ultimate",$(".pyk-ultimate").width(),$(".pyk-ultimate").height(),a.source_name,a.source_link)},this.getParameters=function(){var a=this,b=[];for(var c in a.the_layers)if(a.the_layers[c].name){var d=a.the_layers[c].name,e=a.the_layers[c].values[0].color;b.push({name:d,color:e})}return b},this.onlyFilter=function(a){var b=this.options.filterList.indexOf(a);1===this.options.filterList.length&&-1!=b?this.options.filterList=[]:(this.options.filterList=[],this.options.filterList.push(a)),this.draw()},this.toggleFilter=function(a){var b=this.options.filterList.indexOf(a);-1===b?this.options.filterList.push(a):this.options.filterList.splice(b,1),this.draw()},this.renderLegends=function(){var a=this,b=this.options.width,c=this.getParameters();this.legends_group.selectAll("g.legend_group").remove();var d=this.legends_group.selectAll("g.legend_group").data(c).enter().append("g").attr("class","legend_group").attr("transform",function(a,c){return"translate("+(b-80*c-100)+", 0)"});for(var e in c){var f=d3.select(d[0][e]),g=c[e],h=f.selectAll("text").data([g]);h.enter().append("text"),h.text(function(){return g.name}).attr("x",function(a,b){return 40*b}).attr("dy",-3).on("click",function(b){a.toggleFilter(b.name)});var i=f.selectAll("circle").data([g]);i.enter().append("circle"),i.attr("cx",function(a,b){return 100*b-10}).attr("cy",-6).attr("r",6).attr("style",function(b){var c=-1===a.options.filterList.indexOf(b.name)?"#fff":b.color;return"fill: "+c+"; stroke-width: 3px; stroke:"+b.color})}},this.getGroups=function(){var a={};for(var b in this.the_bars){var c=this.the_bars[b];c.id&&(a[c.group]?a[c.group].push(c.id):a[c.group]=[c.id])}return a},this.renderChart=function(){var a=this,b=this.chart_group.attr("width"),c=this.chart_group.attr("height"),d=this.the_bars,e=this.the_keys,f=this.the_layers,g=this.getGroups(),h=(d3.layout.stack().values(function(a){return a.values})(f),[]);f.map(function(a,b){for(b in a.values){var c=a.values[b];h.push(c.y+c.y0)}});var i=d3.scale.ordinal().domain(d.map(function(a,b){return a.id||b})).rangeBands([0,b-this.options.box_gap],.2),j=Math.max(Math.abs(d3.min(h)),Math.abs(d3.max(h))),k=10,l=(d3.scale.category10(),d3.scale.ordinal().domain(["J","F","M","A","M","J","J","A","S","O","N","D"]).rangeRoundBands([k,b-k],.1),d3.scale.linear().range([c-k,0+k]));l.domain([-j,j]);var m=(d3.scale.linear().domain([-j,j]).range([0,c]).nice(),d3.scale.linear().domain([j,-j]).range([0,c]).nice()),n=(d3.scale.category10(),d3.svg.axis().scale(m).tickSize(-b,0,0).orient("left")),o=d3.svg.axis().scale(i).tickSize(-c,0,0).tickFormat(function(a){return e[a]?e[a]:void 0});this.barchartg.select("g.yaxis").transition(1e3).attr("transform","translate("+this.options.margins.left+", "+this.options.margins.top+")").call(n);var p=parseInt(this.options.margins.top)+parseInt(c);this.barchartg.select("g.xaxis").transition(1e3).attr("transform","translate("+this.options.margins.left+", "+p+")").call(o).selectAll("text").style("text-anchor","start").attr("dy","2px").attr("dx","20px").attr("transform",function(){return"rotate(90)"});var q=[];for(var r in g){var s=g[r],t=i(s[0]),u=i.rangeBand()*s.length+a.options.box_width;t+=u/2,q.push({x:t,name:r})}q.length>1&&this.barchartg.selectAll("text.group_label").data(q).enter().append("text").attr("class","group_label").attr("x",function(b){return b.x+a.options.margins.left}).attr("y",function(){return l(0)+20}).attr("text-anchor","middle").text(function(a){return a.name});var v=this.chart_group.selectAll("g.bars").data(this.barStack(f));v.enter().append("g").attr("class","bars");var w=v.selectAll("rect").data(function(a){return a.values});w.enter().append("g.barchart:rect").attr("height",0).attr("y",c).on("mouseover",function(b){a.tooltip.html(b.tooltip),a.tooltip.style("visibility","visible")}).attr("fill",function(a){return a.color}).on("mousemove",function(){var b=parseInt(a.tooltip.style("height"))+40,c=parseInt(a.tooltip.style("width"))/2;a.tooltip.style("top",d3.event.pageY-b+"px").style("left",d3.event.pageX-c+"px")}).on("mouseout",function(){a.tooltip.style("visibility","hidden")}).on("click",function(b){a.onlyFilter(b.name)}),w.transition().duration(1e3).attr("x",function(a){return i(a.x)}).attr("width",function(){return i.rangeBand()+a.options.box_width}).attr("y",function(a){return l(a.y0)}).attr("height",function(a){return Math.abs(l(0)-l(a.y))})},this.draw=function(){this.options.fullList=this.getParameters().map(function(a){return a.name}),this.options.filterList=0===this.options.filterList.length?this.options.fullList:this.options.filterList;var a=jQuery.extend(!0,[],this.data);a=this.filterData(a);var b=this.flattenData(a);this.the_bars=b[0],this.the_keys=b[1],this.the_layers=this.layers(this.the_bars),this.renderLegends(),this.renderChart()},this.filterData=function(a){var b=this.options.filterList;for(var c in a){var d=a[c];for(var e in d){var f=d[e];for(var g in f){var h=f[g];for(var i in h){var j=h[i];for(var k in j){var l=j[k];-1==b.indexOf(l.name)&&(l.val=0)}break}}}}return a},this.renderTooltip=function(){$("#pyk-ultimate-tooltip").remove(),this.tooltip=d3.select("body").append("div").attr("id","pyk-ultimate-tooltip").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#fff").style("padding","10px 20px").style("box-shadow","0 0 10px #000").style("border-radius","5px").text("a simple tooltip")},this.barStack=function(a){var b=[];console.log("changed input="+a.length),console.log("checking....dzz.="+JSON.stringify(a));var c=a.length;for(console.log("length="+c),a.forEach(function(a){console.log(">>>>>>>>>>>.="+JSON.stringify(a.values)),b.push(a.values)}),console.log("~~~~~~~~~~~="+JSON.stringify(b)),c=b[0].length,console.log("length="+c),c=b[0].length,console.log("length====***="+c);c--;){var d=0,e=0;console.log("loopla"),b.forEach(function(a){console.log("starting,,posBase="+d),console.log("starting,,negBase="+e),a=a[c],a.size=Math.abs(a.y),console.log("dy="+a.y),a.y<0?(console.log("if====*** negBase="+e),a.y0=e,e-=a.size,console.log("if====*** y0="+a.y0)):(console.log("else====*** posBase="+d),a.y0=d+=a.size,console.log("else====*** y0="+a.y0))})}return a.extent=d3.extent(d3.merge(d3.merge(a.map(function(a){return console.log("eeeeee ="+JSON.stringify(a)),[a.y0,a.y0-a.size]})))),console.log("output="+JSON.stringify(a)),a},this.layers=function(a){function b(a){for(var b in d){var e=d[b];if(e.name==a)return e}return c(a)}function c(a){var b={name:a,values:[]};return d.push(b),b}var d=[];for(var e in a){var f=a[e];if(f.id){var g=f.id;for(var h in f)if("id"!==h){var i=f[h];for(var j in i){var k=i[j];if(k.name){var l=b(k.name);l.values.push({x:g,y:k.val,color:k.color,tooltip:k.tooltip,name:k.name})}}}}}return d},this.flattenData=function(a){var b=[-1],c={};for(var d in a){var e=a[d];for(var f in e){for(var g in e[f]){var h="i"+d+"j"+g,i=Object.keys(e[f][g])[0];c[h]=i,e[f][g].id=h,e[f][g].group=f,b.push(e[f][g])}b.push(d)}}return[b,c]},this};